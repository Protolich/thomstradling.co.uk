Ext.ns('Ext.ux.form');Ext.ux.form.DateTime=Ext.extend(Ext.form.Field,{dateValidator:null,defaultAutoCreate:{tag:'input',type:'hidden'},dtSeparator:' ',hiddenFormat:'Y-m-d H:i:s',otherToNow:true,timePosition:'right',timeValidator:null,timeWidth:100,dateFormat:'m/d/y',timeFormat:'g:i A',maxDateValue:'',minDateValue:'',timeIncrement:15,maxTimeValue:null,minTimeValue:null,disabledDates:null,initComponent:function(){Ext.ux.form.DateTime.superclass.initComponent.call(this);if(!this.hasOwnProperty('offset_time')||isNaN(this.offset_time)){this.offset_time=0;}
var dateConfig=Ext.apply({},{id:this.id+'-date',format:this.dateFormat||Ext.form.DateField.prototype.format,width:this.timeWidth,selectOnFocus:this.selectOnFocus,validator:this.dateValidator,disabledDates:this.disabledDates||null,disabledDays:this.disabledDays||[],showToday:this.showToday||true,maxValue:this.maxDateValue||'',minValue:this.minDateValue||'',startDay:this.startDay||0,listeners:{blur:{scope:this,fn:this.onBlur},focus:{scope:this,fn:this.onFocus}}},this.dateConfig);this.df=new Ext.form.DateField(dateConfig);this.df.ownerCt=this;delete(this.dateFormat);delete(this.disabledDates);delete(this.disabledDays);delete(this.maxDateValue);delete(this.minDateValue);delete(this.startDay);var timeConfig=Ext.apply({},{id:this.id+'-time',format:this.timeFormat||Ext.form.TimeField.prototype.format,width:this.timeWidth,selectOnFocus:this.selectOnFocus,validator:this.timeValidator,increment:this.timeIncrement||15,maxValue:this.maxTimeValue||null,minValue:this.minTimeValue||null,listeners:{blur:{scope:this,fn:this.onBlur},focus:{scope:this,fn:this.onFocus}}},this.timeConfig);this.tf=new Ext.form.TimeField(timeConfig);this.tf.ownerCt=this;delete(this.timeFormat);delete(this.maxTimeValue);delete(this.minTimeValue);delete(this.timeIncrement);this.relayEvents(this.df,['focus','specialkey','invalid','valid']);this.relayEvents(this.tf,['focus','specialkey','invalid','valid']);this.on('specialkey',this.onSpecialKey,this);},onRender:function(ct,position){if(this.isRendered){return;}
Ext.ux.form.DateTime.superclass.onRender.call(this,ct,position);var t;if('below'===this.timePosition||'bellow'===this.timePosition){t=Ext.DomHelper.append(ct,{tag:'table',style:'border-collapse:collapse',children:[{tag:'tr',children:[{tag:'td',style:'padding-bottom:1px',cls:'ux-datetime-date'}]},{tag:'tr',children:[{tag:'td',cls:'ux-datetime-time'}]}]},true);}
else{t=Ext.DomHelper.append(ct,{tag:'table',style:'border-collapse:collapse',children:[{tag:'tr',children:[{tag:'td',style:'padding-right:4px',cls:'ux-datetime-date'},{tag:'td',cls:'ux-datetime-time'}]}]},true);}
this.tableEl=t;this.wrap=t.wrap({cls:'x-form-field-wrap x-datetime-wrap'});this.wrap.on("mousedown",this.onMouseDown,this,{delay:10});this.df.render(t.child('td.ux-datetime-date'));this.tf.render(t.child('td.ux-datetime-time'));this.df.el.swallowEvent(['keydown','keypress']);this.tf.el.swallowEvent(['keydown','keypress']);if('side'===this.msgTarget){var elp=this.el.findParent('.x-form-element',10,true);if(elp){this.errorIcon=elp.createChild({cls:'x-form-invalid-icon'});}
var o={errorIcon:this.errorIcon,msgTarget:'side',alignErrorIcon:this.alignErrorIcon.createDelegate(this)};Ext.apply(this.df,o);Ext.apply(this.tf,o);}
this.el.dom.name=this.hiddenName||this.name||this.id;this.df.el.dom.removeAttribute("name");this.tf.el.dom.removeAttribute("name");this.isRendered=true;this.updateHidden();},adjustSize:Ext.BoxComponent.prototype.adjustSize,alignErrorIcon:function(){this.errorIcon.alignTo(this.tableEl,'tl-tr',[2,0]);},initDateValue:function(){this.dateValue=this.otherToNow?new Date():new Date(1970,0,1,0,0,0);},clearInvalid:function(){this.df.clearInvalid();this.tf.clearInvalid();},markInvalid:function(msg){this.df.markInvalid(msg);this.tf.markInvalid(msg);},beforeDestroy:function(){if(this.isRendered){this.wrap.removeAllListeners();this.wrap.remove();this.tableEl.remove();this.df.destroy();this.tf.destroy();}},disable:function(){if(this.isRendered){this.df.disabled=this.disabled;this.df.onDisable();this.tf.onDisable();}
this.disabled=true;this.df.disabled=true;this.tf.disabled=true;this.fireEvent("disable",this);return this;},enable:function(){if(this.rendered){this.df.onEnable();this.tf.onEnable();}
this.disabled=false;this.df.disabled=false;this.tf.disabled=false;this.fireEvent("enable",this);return this;},focus:function(){this.df.focus();},getPositionEl:function(){return this.wrap;},getResizeEl:function(){return this.wrap;},getValue:function(){return this.dateValue?new Date(this.dateValue):'';},isValid:function(){return this.df.isValid()&&this.tf.isValid();},isVisible:function(){return this.df.rendered&&this.df.getActionEl().isVisible();},onBlur:function(f){if(this.wrapClick){f.focus();this.wrapClick=false;}
if(f===this.df){this.updateDate();}
else{this.updateTime();}
this.updateHidden();this.validate();(function(){if(!this.df.hasFocus&&!this.tf.hasFocus){var v=this.getValue();if(String(v)!==String(this.startValue)){this.fireEvent("change",this,v,this.startValue);}
this.hasFocus=false;this.fireEvent('blur',this);}}).defer(100,this);},onFocus:function(){if(!this.hasFocus){this.hasFocus=true;this.startValue=this.getValue();this.fireEvent("focus",this);}},onMouseDown:function(e){if(!this.disabled){this.wrapClick='td'===e.target.nodeName.toLowerCase();}},onSpecialKey:function(t,e){var key=e.getKey();if(key===e.TAB){if(t===this.df&&!e.shiftKey){e.stopEvent();this.tf.focus();}
if(t===this.tf&&e.shiftKey){e.stopEvent();this.df.focus();}
this.updateValue();}
if(key===e.ENTER){this.updateValue();}},reset:function(){this.df.setValue(this.originalValue);this.tf.setValue(this.originalValue);},setDate:function(date){if(date&&this.offset_time!=0){date=date.add(Date.MINUTE,60*new Number(this.offset_time));}
this.df.setValue(date);},setTime:function(date){if(date&&this.offset_time!=0){date=date.add(Date.MINUTE,60*new Number(this.offset_time));}
this.tf.setValue(date);},setSize:function(w,h){if(!w){return;}
if('below'===this.timePosition){this.df.setSize(w,h);this.tf.setSize(w,h);if(Ext.isIE){this.df.el.up('td').setWidth(w);this.tf.el.up('td').setWidth(w);}}
else{this.df.setSize(w-this.timeWidth-4,h);this.tf.setSize(this.timeWidth,h);if(Ext.isIE){this.df.el.up('td').setWidth(w-this.timeWidth-4);this.tf.el.up('td').setWidth(this.timeWidth);}}},setValue:function(val){if(!val&&true===this.emptyToNow){this.setValue(new Date());return;}
else if(!val){this.setDate('');this.setTime('');this.updateValue();return;}
if('number'===typeof val){val=new Date(val);}
else if('string'===typeof val&&this.hiddenFormat){val=Date.parseDate(val,this.hiddenFormat);}
val=val?val:new Date(1970,0,1,0,0,0);var da;if(val instanceof Date){this.setDate(val);this.setTime(val);this.dateValue=new Date(Ext.isIE?val.getTime():val);}
else{da=val.split(this.dtSeparator);this.setDate(da[0]);if(da[1]){if(da[2]){da[1]+=da[2];}
this.setTime(da[1]);}}
this.updateValue();},setVisible:function(visible){if(visible){this.df.show();this.tf.show();}else{this.df.hide();this.tf.hide();}
return this;},show:function(){return this.setVisible(true);},hide:function(){return this.setVisible(false);},updateDate:function(){var d=this.df.getValue();if(d){if(!(this.dateValue instanceof Date)){this.initDateValue();if(!this.tf.getValue()){this.setTime(this.dateValue);}}
this.dateValue.setMonth(0);this.dateValue.setFullYear(d.getFullYear());this.dateValue.setMonth(d.getMonth(),d.getDate());}
else{this.dateValue='';this.setTime('');}},updateTime:function(){var t=this.tf.getValue();if(t&&!(t instanceof Date)){t=Date.parseDate(t,this.tf.format);}
if(t&&!this.df.getValue()){this.initDateValue();this.setDate(this.dateValue);}
if(this.dateValue instanceof Date){if(t){this.dateValue.setHours(t.getHours());this.dateValue.setMinutes(t.getMinutes());this.dateValue.setSeconds(t.getSeconds());}
else{this.dateValue.setHours(0);this.dateValue.setMinutes(0);this.dateValue.setSeconds(0);}}},updateHidden:function(){if(this.isRendered){var value='';if(this.dateValue instanceof Date){value=this.dateValue.add(Date.MINUTE,0-60*new Number(this.offset_time)).format(this.hiddenFormat);}
this.el.dom.value=value;}},updateValue:function(){this.updateDate();this.updateTime();this.updateHidden();return;},validate:function(){return this.df.validate()&&this.tf.validate();},renderer:function(field){var format=field.editor.dateFormat||Ext.ux.form.DateTime.prototype.dateFormat;format+=' '+(field.editor.timeFormat||Ext.ux.form.DateTime.prototype.timeFormat);var renderer=function(val){var retval=Ext.util.Format.date(val,format);return retval;};return renderer;}});Ext.reg('xdatetime',Ext.ux.form.DateTime);;MODx.panel.ImageTV=function(config){config=config||{};config.filemanager_url=MODx.config.filemanager_url;Ext.applyIf(config,{layout:'form',autoHeight:true,border:false,hideLabels:true,defaults:{autoHeight:true,border:false},items:[{xtype:'hidden',name:'tv'+config.tv,id:'tv'+config.tv,value:config.value},{xtype:'modx-combo-browser',browserEl:'tvbrowser'+config.tv,name:'tvbrowser'+config.tv,id:'tvbrowser'+config.tv,triggerClass:'x-form-image-trigger',value:config.relativeValue,hideFiles:true,source:config.source||1,allowedFileTypes:config.allowedFileTypes||'',openTo:config.openTo||'',hideSourceCombo:true,listeners:{'select':{fn:function(data){Ext.getCmp('tv'+this.config.tv).setValue(data.relativeUrl);Ext.getCmp('tvbrowser'+this.config.tv).setValue(data.relativeUrl);this.fireEvent('select',data);},scope:this},'change':{fn:function(cb,nv){Ext.getCmp('tv'+this.config.tv).setValue(nv);this.fireEvent('select',{relativeUrl:nv,url:nv});},scope:this}}}]});MODx.panel.ImageTV.superclass.constructor.call(this,config);this.addEvents({select:true});};Ext.extend(MODx.panel.ImageTV,MODx.Panel);Ext.reg('modx-panel-tv-image',MODx.panel.ImageTV);MODx.panel.FileTV=function(config){config=config||{};config.filemanager_url=MODx.config.filemanager_url;Ext.applyIf(config,{layout:'form',autoHeight:true,border:false,hideLabels:true,defaults:{autoHeight:true,border:false},items:[{xtype:'hidden',name:'tv'+config.tv,id:'tv'+config.tv,value:config.value},{xtype:'modx-combo-browser',browserEl:'tvbrowser'+config.tv,name:'tvbrowser'+config.tv,id:'tvbrowser'+config.tv,value:config.relativeValue,hideFiles:true,source:config.source||1,allowedFileTypes:config.allowedFileTypes||'',wctx:config.wctx||'web',openTo:config.openTo||'',hideSourceCombo:true,listeners:{'select':{fn:function(data){Ext.getCmp('tv'+this.config.tv).setValue(data.relativeUrl);Ext.getCmp('tvbrowser'+this.config.tv).setValue(data.relativeUrl);this.fireEvent('select',data);},scope:this},'change':{fn:function(cb,nv){Ext.getCmp('tv'+this.config.tv).setValue(nv);this.fireEvent('select',{relativeUrl:nv,url:nv});},scope:this}}}]});MODx.panel.FileTV.superclass.constructor.call(this,config);this.addEvents({select:true});};Ext.extend(MODx.panel.FileTV,MODx.Panel);Ext.reg('modx-panel-tv-file',MODx.panel.FileTV);MODx.checkTV=function(id){var cb=Ext.get('tv'+id);Ext.get('tvh'+id).dom.value=cb.dom.checked?cb.dom.value:'';};;MODx.grid.ResourceSecurity=function(config){config=config||{};var ac=new Ext.ux.grid.CheckColumn({header:_('access'),dataIndex:'access',width:40,sortable:false,hidden:MODx.perm.resourcegroup_resource_edit!=1});var qs=Ext.urlDecode(window.location.search.substring(1));Ext.applyIf(config,{id:'modx-grid-resource-security',url:MODx.config.connector_url,baseParams:{action:'resource/resourcegroup/getList',resource:config.resource,"parent":config["parent"],mode:config.mode||'update',"token":qs.reload||''},saveParams:{resource:config.resource},fields:['id','name','access'],paging:true,remoteSort:true,plugins:ac,columns:[{header:_('name'),dataIndex:'name',width:200,sortable:true},ac]});MODx.grid.ResourceSecurity.superclass.constructor.call(this,config);this.on('rowclick',MODx.fireResourceFormChange);};Ext.extend(MODx.grid.ResourceSecurity,MODx.grid.Grid);Ext.reg('modx-grid-resource-security',MODx.grid.ResourceSecurity);;MODx.panel.ResourceTV=function(config){config=config||{};Ext.applyIf(config,{id:'modx-panel-resource-tv',title:_('template_variables'),class_key:'',resource:'',cls:MODx.config.tvs_below_content==1?'x-panel-body tvs-wrapper below-content':'tvs-wrapper x-panel-body',autoHeight:true,applyTo:'modx-resource-tvs-div',header:false,templateField:'modx-resource-template'});MODx.panel.ResourceTV.superclass.constructor.call(this,config);this.addEvents({load:true});};Ext.extend(MODx.panel.ResourceTV,MODx.Panel,{autoload:function(){return false;},refreshTVs:function(){return false;var t=Ext.getCmp(this.config.templateField);if(!t&&!this.config.template){return false;}
var template=this.config.template?this.config.template:t.getValue();this.getUpdater().update({url:MODx.config.manager_url+'?a=resource/tvs',method:'GET',params:{'class_key':this.config.class_key,'template':template,'resource':this.config.resource},scripts:true,callback:function(){this.fireEvent('load');if(MODx.afterTVLoad){MODx.afterTVLoad();}},scope:this});}});Ext.reg('modx-panel-resource-tv',MODx.panel.ResourceTV);;MODx.panel.Resource=function(config){config=config||{record:{}};config.record=config.record||{};Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{},id:'modx-panel-resource',class_key:'modDocument',resource:'',bodyStyle:'',cls:'container form-with-labels',defaults:{collapsible:false,autoHeight:true},forceLayout:true,items:this.getFields(config),fileUpload:true,useLoadingMask:true,listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'failure':{fn:this.failure,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this},'fieldChange':{fn:this.onFieldChange,scope:this}}});MODx.panel.Resource.superclass.constructor.call(this,config);var ta=Ext.get('ta');if(ta){ta.on('keydown',this.fieldChangeEvent,this);}
this.on('ready',this.onReady,this);var urio=Ext.getCmp('modx-resource-uri-override');if(urio){urio.on('check',this.freezeUri);}
this.addEvents('tv-reset');};Ext.extend(MODx.panel.Resource,MODx.FormPanel,{initialized:false,defaultClassKey:'modDocument',classLexiconKey:'document',rteElements:'ta',rteLoaded:false,warnUnsavedChanges:false,setup:function(){if(!this.initialized){this.getForm().setValues(this.config.record);var pcmb=this.getForm().findField('parent-cmb');if(pcmb&&Ext.isEmpty(this.config.record.parent_pagetitle)){pcmb.setValue('');}else if(pcmb){pcmb.setValue(this.config.record.parent_pagetitle+' ('+this.config.record.parent+')');}
if(!Ext.isEmpty(this.config.record.pagetitle)){Ext.getCmp('modx-resource-header').getEl().update('<h2>'+Ext.util.Format.stripTags(this.config.record.pagetitle)+'</h2>');}
if(!Ext.isEmpty(this.config.record.resourceGroups)){var g=Ext.getCmp('modx-grid-resource-security');if(g&&Ext.isEmpty(g.config.url)){var s=g.getStore();if(s){s.loadData(this.config.record.resourceGroups);}}}
this.defaultClassKey=this.config.record.class_key||this.defaultClassKey;this.defaultValues=this.config.record||{};if((this.config.record&&this.config.record.richtext)||MODx.request.reload||MODx.request.activeSave==1){this.markDirty();}
if(MODx.config.confirm_navigation==1){var panel=this;window.onbeforeunload=function(){if(panel.warnUnsavedChanges)return _('unsaved_changes');};}
if(this.config.record.deleted){this.handlePreview('hide');}}
if(MODx.config.use_editor&&MODx.loadRTE){var f=this.getForm().findField('richtext');if(f&&f.getValue()==1&&!this.rteLoaded){MODx.loadRTE(this.rteElements);this.rteLoaded=true;}else if(f&&f.getValue()==0&&this.rteLoaded){if(MODx.unloadRTE){MODx.unloadRTE(this.rteElements);}
this.rteLoaded=false;}}
this.fireEvent('ready');this.initialized=true;MODx.fireEvent('ready');MODx.sleep(4);if(MODx.afterTVLoad){MODx.afterTVLoad();}
this.fireEvent('load');},handlePreview:function(action){var previewBtn=Ext.getCmp('modx-abtn-preview');if(previewBtn==undefined){Ext.defer(function(){this.handlePreview(action);},200,this);}else{var toolBar=Ext.getCmp('modx-page-update-resource').ab,btnIndex=toolBar.items.indexOf(previewBtn);previewBtn[action]();toolBar.items.get(btnIndex+1)[action]();}},beforeDestroy:function(){if(this.rteLoaded&&MODx.unloadRTE){MODx.unloadRTE(this.rteElements);this.rteLoaded=false;}
MODx.panel.Resource.superclass.beforeDestroy.call(this);},beforeSubmit:function(o){var ta=Ext.get('ta');if(ta){var v=ta.dom.value;var hc=Ext.getCmp('hiddenContent');if(hc){hc.setValue(v);}}
var g=Ext.getCmp('modx-grid-resource-security');if(g){Ext.apply(o.form.baseParams,{resource_groups:g.encode()});}
if(ta){this.cleanupEditor();}
if(this.getForm().baseParams.action=='resource/create'){var btn=Ext.getCmp('modx-abtn-save');if(btn){btn.disable();}}
return this.fireEvent('save',{values:this.getForm().getValues(),stay:Ext.state.Manager.get('modx.stay.'+MODx.request.a,'stay')});},success:function(o){this.warnUnsavedChanges=false;var g=Ext.getCmp('modx-grid-resource-security');if(g){g.getStore().commitChanges();}
var t=Ext.getCmp('modx-resource-tree');if(t){var ctx=Ext.getCmp('modx-resource-context-key').getValue();var pa=Ext.getCmp('modx-resource-parent-hidden').getValue();var pao=Ext.getCmp('modx-resource-parent-old-hidden').getValue();var v=ctx+'_'+pa;var n=t.getNodeById(v);if(pa!==pao){t.refresh();Ext.getCmp('modx-resource-parent-old-hidden').setValue(pa);}else{if(typeof n!=="undefined"){n.leaf=false;}
t.refreshNode(v,true);}}
var object=o.result.object;if(this.config.resource&&object.parent!==undefined&&(object.class_key!=this.defaultClassKey||object.parent!=this.defaultValues.parent)){location.href=location.href;}else{if(object.deleted!==this.record.deleted){if(object.deleted){var action='hide';}else{action='show';}
this.handlePreview(action);}
this.record=object;this.getForm().setValues(object);Ext.getCmp('modx-page-update-resource').config.preview_url=object.preview_url;}},failure:function(o){this.warnUnsavedChanges=true;if(this.getForm().baseParams.action=='resource/create'){var btn=Ext.getCmp('modx-abtn-save');if(btn){btn.enable();}}},freezeUri:function(cb){var uri=Ext.getCmp('modx-resource-uri');if(!uri){return false;}
if(cb.checked){uri.show();}else{uri.hide();}},templateWarning:function(){var t=Ext.getCmp('modx-resource-template');if(!t){return false;}
if(t.getValue()!==t.originalValue){Ext.Msg.confirm(_('warning'),_('resource_change_template_confirm'),function(e){if(e=='yes'){var nt=t.getValue();var f=Ext.getCmp('modx-page-update-resource');f.config.action='resource/reload';this.warnUnsavedChanges=false;MODx.activePage.submitForm({success:{fn:function(r){MODx.loadPage(r.result.object.action,'id='+r.result.object.id+'&reload='+r.result.object.reload+'&class_key='+r.result.object.class_key);},scope:this}},{bypassValidCheck:true},{reloadOnly:true});}else{t.setValue(this.config.record.template);}},this);}},onFieldChange:function(o){if(o&&o.field&&o.field.name=='syncsite')return;if(this.isReady||MODx.request.reload){this.warnUnsavedChanges=true;}},cleanupEditor:function(){if(MODx.onSaveEditor){var fld=Ext.getCmp('ta');if(fld){MODx.onSaveEditor(fld);}}},getFields:function(config){var it=[];it.push({title:_(this.classLexiconKey),id:'modx-resource-settings',cls:'modx-resource-tab',layout:'form',labelAlign:'top',labelSeparator:'',bodyCssClass:'tab-panel-wrapper main-wrapper',autoHeight:true,defaults:{border:false,msgTarget:'under',width:400},items:this.getMainFields(config)});it.push({id:'modx-page-settings',title:_('settings'),cls:'modx-resource-tab',layout:'form',forceLayout:true,deferredRender:false,labelWidth:200,bodyCssClass:'main-wrapper',autoHeight:true,defaults:{border:false,msgTarget:'under'},items:this.getSettingFields(config)});if(config.show_tvs&&MODx.config.tvs_below_content!=1){it.push(this.getTemplateVariablesPanel(config));}
if(MODx.perm.resourcegroup_resource_list==1){it.push(this.getAccessPermissionsTab(config));}
var its=[];its.push(this.getPageHeader(config),{id:'modx-resource-tabs',xtype:'modx-tabs',forceLayout:true,deferredRender:false,collapsible:true,animCollapse:false,itemId:'tabs',items:it});var ct=this.getContentField(config);if(ct){its.push({title:_('resource_content'),id:'modx-resource-content',layout:'form',bodyCssClass:'main-wrapper',autoHeight:true,collapsible:true,animCollapse:false,hideMode:'offsets',items:ct});}
if(MODx.config.tvs_below_content==1){var tvs=this.getTemplateVariablesPanel(config);its.push(tvs);}
return its;},getPageHeader:function(config){config=config||{record:{}};return{html:'<h2>'+_('document_new')+'</h2>',id:'modx-resource-header',cls:'modx-page-header',border:false,forceLayout:true,anchor:'100%'};},getTemplateVariablesPanel:function(config){return{xtype:'modx-panel-resource-tv',collapsed:false,resource:config.resource,class_key:config.record.class_key||'modDocument',template:config.record.template,anchor:'100%',border:true,style:'visibility: visible'};},getMainFields:function(config){config=config||{record:{}};return[{layout:'column',border:false,anchor:'100%',id:'modx-resource-main-columns',defaults:{labelSeparator:'',labelAlign:'top',border:false,msgTarget:'under'},items:[{columnWidth:.67,layout:'form',id:'modx-resource-main-left',defaults:{msgTarget:'under'},items:this.getMainLeftFields(config)},{columnWidth:.33,layout:'form',labelWidth:0,border:false,id:'modx-resource-main-right',style:'margin-right: 0',defaults:{msgTarget:'under'},items:this.getMainRightFields(config)}]},{html:MODx.onDocFormRender,border:false},{xtype:'hidden',fieldLabel:_('id'),hideLabel:true,description:'<b>[[*id]]</b><br />',name:'id',id:'modx-resource-id',anchor:'100%',value:config.resource||config.record.id,submitValue:true},{xtype:'hidden',name:'type',value:'document'},{xtype:'hidden',name:'context_key',id:'modx-resource-context-key',value:config.record.context_key||'web'},{xtype:'hidden',name:'content',id:'hiddenContent',value:(config.record.content||config.record.ta)||''},{xtype:'hidden',name:'create-resource-token',id:'modx-create-resource-token',value:config.record.create_resource_token||''},{xtype:'hidden',name:'reloaded',value:!Ext.isEmpty(MODx.request.reload)?1:0},{xtype:'hidden',name:'parent',value:config.record.parent||0,id:'modx-resource-parent-hidden'},{xtype:'hidden',name:'parent-original',value:config.record.parent||0,id:'modx-resource-parent-old-hidden'}];},getMainLeftFields:function(config){config=config||{record:{}};return[{xtype:'textfield',fieldLabel:_('resource_pagetitle')+'<span class="required">*</span>',description:'<b>[[*pagetitle]]</b><br />'+_('resource_pagetitle_help'),name:'pagetitle',id:'modx-resource-pagetitle',maxLength:255,anchor:'100%',allowBlank:false,enableKeyEvents:true,listeners:{'keyup':{scope:this,fn:function(f,e){var titlePrefix=MODx.request.a=='resource/create'?_('new_document'):_('document');var title=Ext.util.Format.stripTags(f.getValue());Ext.getCmp('modx-resource-header').getEl().update('<h2>'+title+'</h2>');}}}},{xtype:'textfield',fieldLabel:_('resource_longtitle'),description:'<b>[[*longtitle]]</b><br />'+_('resource_longtitle_help'),name:'longtitle',id:'modx-resource-longtitle',maxLength:255,anchor:'100%',value:config.record.longtitle||''},{xtype:'textarea',fieldLabel:_('resource_description'),description:'<b>[[*description]]</b><br />'+_('resource_description_help'),name:'description',id:'modx-resource-description',maxLength:255,anchor:'100%',value:config.record.description||''},{xtype:'textarea',fieldLabel:_('resource_summary'),description:'<b>[[*introtext]]</b><br />'+_('resource_summary_help'),name:'introtext',id:'modx-resource-introtext',grow:true,anchor:'100%',value:config.record.introtext||''}];},getMainRightFields:function(config){config=config||{};return[{xtype:'modx-combo-template',fieldLabel:_('resource_template'),description:'<b>[[*template]]</b><br />'+_('resource_template_help'),name:'template',id:'modx-resource-template',anchor:'100%',editable:false,baseParams:{action:'element/template/getList',combo:'1',limit:0},listeners:{'select':{fn:this.templateWarning,scope:this}}},{xtype:'textfield',fieldLabel:_('resource_alias'),description:'<b>[[*alias]]</b><br />'+_('resource_alias_help'),name:'alias',id:'modx-resource-alias',maxLength:100,anchor:'100%',value:config.record.alias||''},{xtype:'textfield',fieldLabel:_('resource_menutitle'),description:'<b>[[*menutitle]]</b><br />'+_('resource_menutitle_help'),name:'menutitle',id:'modx-resource-menutitle',maxLength:255,anchor:'100%',value:config.record.menutitle||''},{xtype:'textfield',fieldLabel:_('resource_link_attributes'),description:'<b>[[*link_attributes]]</b><br />'+_('resource_link_attributes_help'),name:'link_attributes',id:'modx-resource-link-attributes',maxLength:255,anchor:'100%',value:config.record.link_attributes||''},{xtype:'xcheckbox',boxLabel:_('resource_hide_from_menus'),hideLabel:true,description:'<b>[[*hidemenu]]</b><br />'+_('resource_hide_from_menus_help'),name:'hidemenu',id:'modx-resource-hidemenu',inputValue:1,checked:parseInt(config.record.hidemenu)||false},{xtype:'xcheckbox',boxLabel:_('resource_published'),hideLabel:true,description:'<b>[[*published]]</b><br />'+_('resource_published_help'),name:'published',id:'modx-resource-published',inputValue:1,checked:parseInt(config.record.published)}]},getSettingFields:function(config){config=config||{record:{}};var s=[{layout:'column',border:false,anchor:'100%',defaults:{labelSeparator:'',labelAlign:'top',border:false,layout:'form',msgTarget:'under'},items:[{columnWidth:.5,id:'modx-page-settings-left',defaults:{msgTarget:'under'},items:this.getSettingLeftFields(config)},{columnWidth:.5,id:'modx-page-settings-right',defaults:{msgTarget:'under'},items:this.getSettingRightFields(config)}]}];return s;},getSettingLeftFields:function(config){return[{xtype:'modx-field-parent-change',fieldLabel:_('resource_parent'),description:'<b>[[*parent]]</b><br />'+_('resource_parent_help'),name:'parent-cmb',id:'modx-resource-parent',value:config.record.parent||0,anchor:'100%'},{xtype:'modx-combo-class-derivatives',fieldLabel:_('resource_type'),description:'<b>[[*class_key]]</b><br />',name:'class_key',hiddenName:'class_key',id:'modx-resource-class-key',allowBlank:false,value:config.record.class_key||'modDocument',anchor:'100%'},{xtype:'modx-combo-content-type',fieldLabel:_('resource_content_type'),description:'<b>[[*content_type]]</b><br />'+_('resource_content_type_help'),name:'content_type',hiddenName:'content_type',id:'modx-resource-content-type',anchor:'100%',value:config.record.content_type||(MODx.config.default_content_type||1)},{xtype:'modx-combo-content-disposition',fieldLabel:_('resource_contentdispo'),description:'<b>[[*content_dispo]]</b><br />'+_('resource_contentdispo_help'),name:'content_dispo',hiddenName:'content_dispo',id:'modx-resource-content-dispo',anchor:'100%',value:config.record.content_dispo||0},{xtype:'numberfield',fieldLabel:_('resource_menuindex'),description:'<b>[[*menuindex]]</b><br />'+_('resource_menuindex_help'),name:'menuindex',id:'modx-resource-menuindex',width:75,value:parseInt(config.record.menuindex)||0}];},getSettingRightFields:function(config){return[{xtype:'xdatetime',fieldLabel:_('resource_publishedon'),description:'<b>[[*publishedon]]</b><br />'+_('resource_publishedon_help'),name:'publishedon',id:'modx-resource-publishedon',allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,startDay:parseInt(MODx.config.manager_week_start),dateWidth:120,timeWidth:120,offset_time:MODx.config.server_offset_time,value:config.record.publishedon},{xtype:MODx.config.publish_document?'xdatetime':'hidden',fieldLabel:_('resource_publishdate'),description:'<b>[[*pub_date]]</b><br />'+_('resource_publishdate_help'),name:'pub_date',id:'modx-resource-pub-date',allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,startDay:parseInt(MODx.config.manager_week_start),dateWidth:120,timeWidth:120,offset_time:MODx.config.server_offset_time,value:config.record.pub_date},{xtype:MODx.config.publish_document?'xdatetime':'hidden',fieldLabel:_('resource_unpublishdate'),description:'<b>[[*unpub_date]]</b><br />'+_('resource_unpublishdate_help'),name:'unpub_date',id:'modx-resource-unpub-date',allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,startDay:parseInt(MODx.config.manager_week_start),dateWidth:120,timeWidth:120,offset_time:MODx.config.server_offset_time,value:config.record.unpub_date},{xtype:'fieldset',items:this.getSettingRightFieldset(config)}];},getSettingRightFieldset:function(config){return[{layout:'column',id:'modx-page-settings-box-columns',border:false,anchor:'100%',defaults:{labelSeparator:'',labelAlign:'top',border:false,layout:'form',msgTarget:'under'},items:[{columnWidth:.5,id:'modx-page-settings-right-box-left',defaults:{msgTarget:'under'},items:this.getSettingRightFieldsetLeft(config)},{columnWidth:.5,id:'modx-page-settings-right-box-right',defaults:{msgTarget:'under'},items:this.getSettingRightFieldsetRight(config)}]},{xtype:'xcheckbox',boxLabel:_('resource_uri_override'),description:_('resource_uri_override_help'),hideLabel:true,name:'uri_override',value:1,checked:parseInt(config.record.uri_override)?true:false,id:'modx-resource-uri-override'},{xtype:'textfield',fieldLabel:_('resource_uri'),description:'<b>[[*uri]]</b><br />'+_('resource_uri_help'),name:'uri',id:'modx-resource-uri',maxLength:255,anchor:'70%',value:config.record.uri||'',hidden:!config.record.uri_override}];},getSettingRightFieldsetLeft:function(config){return[{xtype:'xcheckbox',boxLabel:_('resource_folder'),description:'<b>[[*isfolder]]</b><br />'+_('resource_folder_help'),hideLabel:true,name:'isfolder',id:'modx-resource-isfolder',inputValue:1,checked:parseInt(config.record.isfolder)||0},{xtype:'xcheckbox',boxLabel:_('resource_searchable'),description:'<b>[[*searchable]]</b><br />'+_('resource_searchable_help'),hideLabel:true,name:'searchable',id:'modx-resource-searchable',inputValue:1,checked:parseInt(config.record.searchable)},{xtype:'xcheckbox',boxLabel:_('resource_richtext'),description:'<b>[[*richtext]]</b><br />'+_('resource_richtext_help'),hideLabel:true,name:'richtext',id:'modx-resource-richtext',inputValue:1,checked:parseInt(config.record.richtext)}];},getSettingRightFieldsetRight:function(config){return[{xtype:'xcheckbox',boxLabel:_('resource_cacheable'),description:'<b>[[*cacheable]]</b><br />'+_('resource_cacheable_help'),hideLabel:true,name:'cacheable',id:'modx-resource-cacheable',inputValue:1,checked:parseInt(config.record.cacheable)},{xtype:'xcheckbox',boxLabel:_('resource_syncsite'),description:_('resource_syncsite_help'),hideLabel:true,name:'syncsite',id:'modx-resource-syncsite',inputValue:1,checked:config.record.syncsite!==undefined&&config.record.syncsite!==null?parseInt(config.record.syncsite):true},{xtype:'xcheckbox',boxLabel:_('deleted'),description:'<b>[[*deleted]]</b>',hideLabel:true,name:'deleted',id:'modx-resource-deleted',inputValue:1,checked:parseInt(config.record.deleted)||false}];},getContentField:function(config){return[{id:'modx-content-above',border:false},{xtype:'textarea',name:'ta',id:'ta',cls:'modx-code-content',hideLabel:true,anchor:'100%',height:400,grow:false,value:(config.record.content||config.record.ta)||''},{id:'modx-content-below',border:false}];},getAccessPermissionsTab:function(config){return{id:'modx-resource-access-permissions',autoHeight:true,title:_('resource_groups'),layout:'form',anchor:'100%',items:[{html:'<p>'+_('resource_access_message')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-resource-security',cls:'main-wrapper',preventRender:true,resource:config.resource,mode:config.mode||'update',"parent":config.record["parent"]||0,"token":config.record.create_resource_token,reloaded:!Ext.isEmpty(MODx.request.reload),listeners:{'afteredit':{fn:this.fieldChangeEvent,scope:this}}}]};}});Ext.reg('modx-panel-resource',MODx.panel.Resource);var triggerDirtyField=function(fld){Ext.getCmp('modx-panel-resource').fieldChangeEvent(fld);};MODx.triggerRTEOnChange=function(){triggerDirtyField(Ext.getCmp('ta'));};MODx.fireResourceFormChange=function(f,nv,ov){Ext.getCmp('modx-panel-resource').fireEvent('fieldChange');};;MODx.page.UpdateResource=function(config){config=config||{record:{}};config.record=config.record||{};Ext.apply(config.record,{'parent-cmb':config.record['parent']});Ext.applyIf(config,{url:MODx.config.connector_url,which_editor:'none',formpanel:'modx-panel-resource',id:'modx-page-update-resource',action:'resource/update',components:[{xtype:config.panelXType||'modx-panel-resource',renderTo:config.panelRenderTo||'modx-panel-resource-div',resource:config.resource,record:config.record||{},publish_document:config.publish_document,access_permissions:config.access_permissions,show_tvs:config.show_tvs,mode:config.mode,url:config.url}],buttons:this.getButtons(config)});MODx.page.UpdateResource.superclass.constructor.call(this,config);if(!Ext.isIE){Ext.EventManager.on(window,'beforeunload',function(e){MODx.releaseLock(this.config.resource);MODx.sleep(400);return false;},this);}
new Ext.KeyMap(Ext.getBody(),{key:'p',alt:true,ctrl:true,fn:this.preview,scope:this});};Ext.extend(MODx.page.UpdateResource,MODx.Component,{preview:function(){window.open(this.config.preview_url);return false;},duplicateResource:function(btn,e){MODx.msg.confirm({text:_('resource_duplicate_confirm'),url:MODx.config.connector_url,params:{action:'resource/duplicate',id:this.config.resource},listeners:{success:{fn:function(r){MODx.loadPage('resource/update','id='+r.object.id);},scope:this}}});},deleteResource:function(btn,e){MODx.msg.confirm({text:_('resource_delete_confirm'),url:MODx.config.connector_url,params:{action:'resource/delete',id:this.config.resource},listeners:{success:{fn:function(r){MODx.loadPage('resource/update','id='+r.object.id);},scope:this}}});},cancel:function(btn,e){var fp=Ext.getCmp(this.config.formpanel);if(fp&&fp.isDirty()){Ext.Msg.confirm(_('warning'),_('resource_cancel_dirty_confirm'),function(e){if(e=='yes'){fp.warnUnsavedChanges=false;MODx.releaseLock(MODx.request.id);MODx.sleep(400);MODx.loadPage('?');}},this);}else{MODx.releaseLock(MODx.request.id);MODx.loadPage('?');}},getButtons:function(cfg){var btns=[];if(cfg.canSave==1){btns.push({process:'resource/update',text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]});}else if(cfg.locked){btns.push({text:cfg.lockedText||_('locked'),id:'modx-abtn-locked',handler:Ext.emptyFn,disabled:true});}
if(cfg.canDuplicate==1&&(cfg.record.parent!==parseInt(MODx.config.tree_root_id)||cfg.canCreateRoot==1)){btns.push({text:_('duplicate'),id:'modx-abtn-duplicate',handler:this.duplicateResource,scope:this});}
if(cfg.canDelete==1&&!cfg.locked){btns.push({text:_('delete'),id:'modx-abtn-delete',handler:this.deleteResource,scope:this});}
btns.push({text:_('view'),id:'modx-abtn-preview',handler:this.preview,scope:this});btns.push({text:_('cancel'),id:'modx-abtn-cancel',handler:this.cancel,scope:this});btns.push({text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane});return btns;}});Ext.reg('modx-page-resource-update',MODx.page.UpdateResource);;var Articles=function(config){config=config||{};Articles.superclass.constructor.call(this,config);};Ext.extend(Articles,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{},extra:{},connector_url:''});Ext.reg('Articles',Articles);Articles=new Articles();Articles.combo.PublishStatus=function(config){config=config||{};Ext.applyIf(config,{store:[[1,_('published')],[0,_('unpublished')]],name:'published',hiddenName:'published',triggerAction:'all',editable:false,selectOnFocus:false,preventRender:true,forceSelection:true,enableKeyEvents:true});Articles.combo.PublishStatus.superclass.constructor.call(this,config);};Ext.extend(Articles.combo.PublishStatus,MODx.combo.ComboBox);Ext.reg('articles-combo-publish-status',Articles.combo.PublishStatus);Articles.combo.FilterStatus=function(config){config=config||{};Ext.applyIf(config,{store:[['',_('articles.all')],['published',_('published')],['unpublished',_('unpublished')],['deleted',_('deleted')]],name:'filter',hiddenName:'filter',triggerAction:'all',editable:false,selectOnFocus:false,preventRender:true,forceSelection:true,enableKeyEvents:true,emptyText:_('articles.filter_ellipsis')});Articles.combo.FilterStatus.superclass.constructor.call(this,config);};Ext.extend(Articles.combo.FilterStatus,MODx.combo.ComboBox);Ext.reg('articles-combo-filter-status',Articles.combo.FilterStatus);Articles.PanelSpacer={html:'<br />',border:false,cls:'articles-panel-spacer'};;Articles.combo.Tag=function(config,getStore){config=config||{};Ext.applyIf(config,{name:'fake_tags',hiddenName:'fake_tags',displayField:'tag',valueField:'tag',fields:['tag'],mode:'remote',allowAddNewData:true,addNewDataOnBlur:false,itemDelimiterKey:188,triggerAction:'all',typeAheadDelay:50,minChars:1,typeAhead:true,editable:true,forceSelection:false,pageSize:20,url:Articles.connector_url,baseParams:{action:'extras/gettags'}});Ext.applyIf(config,{store:new Ext.data.JsonStore({url:config.url,root:'results',totalProperty:'total',fields:config.fields,errorReader:MODx.util.JSONReader,baseParams:config.baseParams||{},remoteSort:config.remoteSort||false,autoDestroy:true})});if(getStore===true){config.store.load();return config.store;}
Articles.combo.Tag.superclass.constructor.call(this,config);this.on('newitem',function(bs,v,f){v=v.split(',');Ext.each(v,function(item){item=item.replace(/^\s+|\s+$/g,'');var newObj={tag:item};bs.addNewItem(newObj);});});this.on('removeitem',function(combo){combo.lastQuery='';MODx.fireResourceFormChange();});this.on('blur',function(combo){if(combo.lastQuery){var v=combo.lastQuery.split(',');Ext.each(v,function(item){item=item.replace(/^\s+|\s+$/g,'');var newObj={tag:item};combo.addNewItem(newObj);});}});this.config=config;return this;};Ext.extend(Articles.combo.Tag,Ext.ux.form.SuperBoxSelect,{setValue:function(value){if(!this.rendered){this.value=value;return;}
this.removeAllItems().resetStore();this.remoteLookup=[];if(Ext.isEmpty(value)){return;}
var values=value;if(!Ext.isArray(value)){value=''+value;values=value.split(this.valueDelimiter);}
Ext.each(values,function(val){val=val.replace(/^\s+|\s+$/g,'');var record=this.findRecord(this.valueField,val);if(record){this.addRecord(record);}else if(this.mode==='remote'){this.remoteLookup.push(val);}},this);if(this.mode==='remote'){var q=this.remoteLookup.join(this.queryValuesDelimiter);this.doQuery(q,false,true);}}});Ext.reg('articles-combo-tag',Articles.combo.Tag);;Articles.extra.Tags=function(config){config=config||{};Ext.apply(config,{ignoreCase:false,valueField:'tag',displayField:'tag',minChars:3});Articles.extra.Tags.superclass.constructor.call(this,config);this.addEvents('additem','removeitem');};Ext.extend(Articles.extra.Tags,Ext.form.ComboBox,{mode:'local',hideTrigger:true,defaultAutoCreate:{tag:"input",type:"text",size:"24",autocomplete:"on"},myStore:new Ext.data.ArrayStore({autoDestroy:true,storeId:'tagsStore',idIndex:0,fields:['tag']}),store:new Ext.data.ArrayStore({autoDestroy:true,storeId:'autoCompleteStore',idIndex:0,fields:['tag'],data:[]}),initValue:function(){if(this.value!==undefined){this.setValue(this.value);}else if(!Ext.isEmpty(this.el.dom.value)&&this.el.dom.value!=this.emptyText){this.setValue(this.el.dom.value);}
this.originalValue=this.getFieldValue();},onFocus:function(){this.preFocus();if(this.focusClass){this.el.addClass(this.focusClass);}
if(!this.hasFocus){this.hasFocus=true;this.startValue=this.getFieldValue();this.fireEvent('focus',this);}},isDirty:function(){if(this.disabled||!this.rendered){return false;}
return String(this.getFieldValue())!==String(this.originalValue);},append:function(v){this.setValue([this.getFieldValue(),v].join(''));},getValue:function(){var restValues=this.getFieldValue();if(restValues==''||restValues==undefined)restValues='';restValues=restValues.split(/\s*[,]\s*/);Ext.each(restValues,function(value){var record=new Ext.data.Record({tag:value},value);this.myStore.add([record]);},this);return this.myStore.collect('tag').join();},setValue:function(v){while(this.insertedTagsEl.dom.firstChild!=null){this.insertedTagsEl.dom.firstChild.remove();}
this.myStore.clearData();if(v instanceof Array){v=v.join();}
this.addItems(v);},setFieldValue:function(v){var text=v;if(this.valueField){var r=this.findRecord(this.valueField,v);if(r){text=r.data[this.displayField];}else if(Ext.isDefined(this.valueNotFoundText)){text=this.valueNotFoundText;}}
this.lastSelectionText=text;if(this.hiddenField){this.hiddenField.value=Ext.value(v,'');}
Ext.form.ComboBox.superclass.setValue.call(this,text);this.value=v;return this;},getFieldValue:function(){return this.value;},onRender:function(ct,position){if(this.hiddenName&&!Ext.isDefined(this.submitValue)){this.submitValue=false;}
Ext.form.ComboBox.superclass.onRender.call(this,ct,position);this.el.parent().wrap({tag:'div',class:'bxr-field-tags'});this.el.parent().wrap({tag:'div',class:'bxr-field-wrapper'});this.el.parentNode=this.el.parent().parent().parent();Ext.DomHelper.insertAfter(this.el.parent().parent(),{tag:'ul'});Ext.DomHelper.insertAfter(this.el.parent(),{tag:'button',html:'Add',class:'x-btn'});this.addButton=this.el.parentNode.child('button');this.insertedTagsEl=this.el.parentNode.child('ul');this.insertedTagsEl.wrap({tag:'div',class:'inserted-tags'});this.addButton.on('click',this.addItemsFromField,this);if(this.hiddenName){this.hiddenField=this.el.insertSibling({tag:'input',type:'hidden',name:this.hiddenName,id:(this.hiddenId||Ext.id())},'before',true);}
if(Ext.isGecko){this.el.dom.setAttribute('autocomplete','off');}
if(!this.lazyInit){this.initList();}else{this.on('focus',this.initList,this,{single:true});}},addItemsFromField:function(){this.addItems(this.getFieldValue());},addItems:function(items){items=Ext.isEmpty(items)?'':items;var values=items.split(/\s*[,]\s*/);Ext.each(values,function(value){if(this.ignoreCase){value=value.toLowerCase();}
if(value==''){return;}
var item=new Articles.extra.TagsItem({owner:this,renderTo:this.insertedTagsEl,value:value,listeners:{remove:function(item){this.fireEvent('removeitem',this,item);},scope:this}});item.render();this.fireEvent('additem',this,value);},this);this.setFieldValue();},doQuery:function(q,forceAll){this.value=q;q=Ext.isEmpty(q)?'':q;q=q.split(',');q=q[q.length-1];q=q.replace(/^\s+|\s+$/g,'');var qe={query:q,forceAll:forceAll,combo:this,cancel:false};if(this.fireEvent('beforequery',qe)===false||qe.cancel){return false;}
q=qe.query;forceAll=qe.forceAll;if(forceAll===true||(q.length>=this.minChars)){if(this.lastQuery!==q){this.lastQuery=q;if(this.mode=='local'){this.selectedIndex=-1;if(forceAll){this.store.clearFilter();}else{this.store.filter(this.displayField,q,true);}
this.onLoad();}else{this.store.baseParams[this.queryParam]=q;this.store.load({params:this.getParams(q)});this.expand();}}else{this.selectedIndex=-1;this.onLoad();}}},onSelect:function(record,index){if(this.fireEvent('beforeselect',this,record,index)!==false){var values=this.getFieldValue().split(/\s*[,]\s*/);values.pop();values.push(record.data[this.valueField||this.displayField]);values.push('');this.setFieldValue(values.join(', '));this.collapse();this.fireEvent('select',this,record,index);}}});Ext.reg('bxr-field-tags',Articles.extra.Tags);Articles.extra.TagsItem=function(config){Ext.apply(this,config);Ext.ux.form.SuperBoxSelectItem.superclass.constructor.call(this);this.addEvents('remove');};Ext.extend(Articles.extra.TagsItem,Ext.Component,{renderCurrentItem:true,initComponent:function(){Articles.extra.TagsItem.superclass.initComponent.call(this);this.renderCurrentItem=true;var itemsCount=this.owner.myStore.getCount();var record=new Ext.data.Record({tag:this.value},this.value);this.owner.myStore.add([record]);if(itemsCount==this.owner.myStore.getCount())this.renderCurrentItem=false;},onRender:function(ct,position){if(!this.renderCurrentItem)return true;Articles.extra.TagsItem.superclass.onRender.call(this,ct,position);var el=this.el;if(el){el.remove();}
this.el=el=ct.createChild({tag:'li'},ct.last());el.addClass('x-superboxselect-item');var btnEl=this.owner.navigateItemsWithTab?(Ext.isSafari?'button':'a'):'span';Ext.apply(el,{focus:function(){var c=this.down(btnEl+'.x-superboxselect-item-close');if(c){c.focus();}},preDestroy:function(){this.preDestroy();}.createDelegate(this)});el.update(this.value);var cfg={tag:btnEl,'class':'x-superboxselect-item-close',tabIndex:this.owner.navigateItemsWithTab?'0':'-1'};if(btnEl==='a'){cfg.href='#';}
this.lnk=el.createChild(cfg);this.lnk.on('click',function(){var record=new Ext.data.Record({tag:this.value},this.value);this.el.remove();this.owner.myStore.remove(this.owner.myStore.getById(this.value));this.fireEvent('remove',this,this.value);},this);},onDestroy:function(){Ext.destroy(this.lnk,this.el);Articles.extra.TagsItem.superclass.onDestroy.call(this);}});;var Quip=function(config){config=config||{};Quip.superclass.constructor.call(this,config);};Ext.extend(Quip,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{}});Ext.reg('quip',Quip);var Quip=new Quip();;Quip.grid.Comments=function(config){config=config||{};this.sm=new Ext.grid.CheckboxSelectionModel();this.ident=config.ident||'quip-'+Ext.id();Ext.applyIf(config,{url:Quip.config.connector_url,baseParams:{action:'mgr/comment/getList',thread:config.thread||null,family:config.family||null},fields:['id','author','username','body','createdon','name','approved','deleted','ip','url','pagetitle','comments','website','email','cls'],paging:true,autosave:false,remoteSort:true,autoExpandColumn:'body',sm:this.sm,columns:[this.sm,{header:_('quip.comment'),dataIndex:'username',sortable:false,width:400,renderer:this.renderAuthor},{header:_('quip.posted'),dataIndex:'createdon',sortable:false,editable:false,align:'right',width:100,renderer:this._renderPosted},{header:_('quip.thread'),dataIndex:'url',sortable:false,editable:false,width:100,renderer:this._renderUrl}],viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:function(rec,ri,p){var cls='quip-comment';if(!rec.data.approved)cls+=' quip-unapproved';if(rec.data.deleted)cls+=' quip-deleted';if(this.showPreview){p.body='<div class="quip-comment-body">'+rec.data.body+'</div>';return cls+' quip-comment-expanded';}
return cls+' quip-comment-collapsed';}},tbar:[{text:_('quip.bulk_actions'),menu:[{text:_('quip.approve_selected'),handler:this.approveSelected,scope:this},{text:_('quip.delete_selected'),handler:this.deleteSelected,scope:this},'-',{text:_('quip.remove_selected'),handler:this.removeSelected,scope:this}]},{text:_('quip.show_deleted'),handler:this.toggleDeleted,enableToggle:true,scope:this},'->',{xtype:'textfield',name:'search',id:this.ident+'-tf-search',emptyText:_('search')+'...',listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this.getValue());this.blur();return true;},scope:cmp});},scope:this}}},{xtype:'button',id:this.ident+'-filter-clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}}]});Quip.grid.Comments.superclass.constructor.call(this,config)};Ext.extend(Quip.grid.Comments,MODx.grid.Grid,{_addEnterKeyHandler:function(){this.getEl().addKeyListener(Ext.EventObject.ENTER,function(){this.fireEvent('change');},this);},clearFilter:function(){var s=this.getStore();s.baseParams.search='';Ext.getCmp(this.ident+'-tf-search').reset();this.getBottomToolbar().changePage(1);this.refresh();},search:function(tf,newValue,oldValue){var nv=newValue||tf;this.getStore().baseParams.search=nv;this.getBottomToolbar().changePage(1);this.refresh();return true;},renderAuthor:function(value,p,rec){return String.format('<span class="quip-author"><b>{1}</b>: <a href="mailto:{2}">{2}</a><br /><i>{0}</i></span>',value,rec.data.name,rec.data.email,rec.data.approved);return value;},_renderUrl:function(v,md,rec){return'<a href="'+rec.data.url+'" target="_blank">'+rec.data.pagetitle+'</a><br /><i>'+rec.data.comments+' '+_('quip.comments')+'</i>';},_renderPosted:function(v,md,rec){var cls='quip-posted';if(!rec.data.approved)cls+=' quip-unapproved';if(rec.data.deleted)cls+=' quip-deleted';return'<div class="'+cls+'">'+v+'<br /><span class="quip-ip">'+rec.data.ip+'</span></div>';},toggleDeleted:function(btn,e){var s=this.getStore();if(btn.pressed){s.setBaseParam('deleted',1);btn.setText(_('quip.hide_deleted'));}else{s.setBaseParam('deleted',0);btn.setText(_('quip.show_deleted'));}
this.getBottomToolbar().changePage(1);s.removeAll();this.refresh();},approveSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/approveMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},unapproveSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/unapproveMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},deleteSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/deleteMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},undeleteSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/undeleteMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},removeSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/removeMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},updateComment:function(btn,e){if(!this.updateCommentWindow){this.updateCommentWindow=MODx.load({xtype:'quip-window-comment-update',record:this.menu.record,listeners:{'success':{fn:this.refresh,scope:this}}});}
this.updateCommentWindow.setValues(this.menu.record);this.updateCommentWindow.show(e.target);},rejectComment:function(btn,e){if(!this.rejectCommentWindow){this.rejectCommentWindow=MODx.load({xtype:'quip-window-comment-reject',record:this.menu.record,listeners:{'success':{fn:this.refresh,scope:this}}});}
this.rejectCommentWindow.setValues(this.menu.record);this.rejectCommentWindow.show(e.target);},approveComment:function(){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/approve',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},unapproveComment:function(){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/unapprove',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},deleteComment:function(){MODx.msg.confirm({title:_('warning'),text:_('quip.comment_delete_confirm'),url:this.config.url,params:{action:'mgr/comment/delete',id:this.menu.record.id},listeners:{'success':{fn:this.removeActiveRow,scope:this}}});},undeleteComment:function(){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/undelete',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},removeComment:function(){MODx.msg.confirm({title:_('warning'),text:_('quip.comment_remove_confirm'),url:this.config.url,params:{action:'mgr/comment/remove',id:this.menu.record.id},listeners:{'success':{fn:this.removeActiveRow,scope:this}}});},verifyPerm:function(perm,rs){var valid=true;for(var i=0;i<rs.length;i++){if(rs[i].data.cls.indexOf(perm)==-1){valid=false;}}
return valid;},getMenu:function(){var m=[];if(this.getSelectionModel().getCount()>1){var rs=this.getSelectionModel().getSelections();if(this.verifyPerm('approve',rs)){m.push({text:_('quip.comment_approve_selected'),handler:this.approveSelected});m.push({text:_('quip.comment_unapprove_selected'),handler:this.unapproveSelected});}
if(this.verifyPerm('remove',rs)){if(m.length>0){m.push('-');}
m.push({text:_('quip.comment_delete_selected'),handler:this.deleteSelected});m.push({text:_('quip.comment_undelete_selected'),handler:this.undeleteSelected});m.push('-');m.push({text:_('quip.comment_remove_selected'),handler:this.removeSelected});}}else{var n=this.menu.record;var cls=n.cls.split(',');if(cls.indexOf('pupdate')!=-1){m.push({text:_('quip.comment_update'),handler:this.updateComment});}
if(cls.indexOf('papprove')!=-1&&n.approved==0){m.push({text:_('quip.comment_approve'),handler:this.approveComment})}else if(cls.indexOf('papprove')!=-1&&n.approved==1){m.push({text:_('quip.comment_unapprove'),handler:this.unapproveComment});}
if(cls.indexOf('premove')!=-1&&n.deleted==0){m.push({text:_('quip.comment_delete'),handler:this.deleteComment})}else if(cls.indexOf('premove')!=-1&&n.deleted==1){m.push({text:_('quip.comment_undelete'),handler:this.undeleteComment});}
if(cls.indexOf('premove')!=-1&&n.deleted==1){m.push('-');m.push({text:_('quip.comment_remove'),handler:this.removeComment});}}
if(m.length>0){this.addContextMenuItem(m);}}});Ext.reg('quip-grid-comments',Quip.grid.Comments);Quip.window.UpdateComment=function(config){config=config||{};Ext.applyIf(config,{title:_('quip.comment_update'),url:Quip.config.connector_url,baseParams:{action:'mgr/comment/update'},width:600,fields:[{xtype:'hidden',name:'id'},{xtype:'textfield',fieldLabel:_('quip.name'),name:'name',anchor:'90%'},{xtype:'textfield',fieldLabel:_('quip.email'),name:'email',anchor:'90%'},{xtype:'textfield',fieldLabel:_('quip.website'),name:'website',anchor:'90%'},{xtype:'statictextfield',fieldLabel:_('quip.ip'),name:'ip',anchor:'90%',submitValue:false},{xtype:'textarea',hideLabel:true,name:'body',width:550,grow:true}],keys:[]});Quip.window.UpdateComment.superclass.constructor.call(this,config);};Ext.extend(Quip.window.UpdateComment,MODx.Window);Ext.reg('quip-window-comment-update',Quip.window.UpdateComment);